<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventura - Email Setup</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 min-h-screen">
    <div class="max-w-md mx-auto p-6">
        <div class="flex items-center mb-12">
            <a href="step2-otp.html" class="text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <div class="bg-white p-2 rounded-md ml-2">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="navy">
                    <path d="M12 2L2 22h20L12 2zm0 3l7.5 15h-15L12 5z" />
                </svg>
            </div>
            <h1 class="text-white text-3xl ml-2 font-semibold">ventura</h1>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-lg">
           Lorem ipsum dolor sit amet consectetur adipisicing elit. Incidunt labore blanditiis delectus porro numquam eligendi nostrum magnam. Sapiente consectetur laudantium illo harum nihil. Perspiciatis quae harum soluta accusamus quibusdam quasi.
        </div>
    </div>
</body>
</html> -->

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Liveness and Gaze Estimation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
  
        .video-container mx-auto {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: auto;
            aspect-ratio: 1;
            background-color: #e6e6e6;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 8px;
            border: 2px solid red;
            
        }
        
    
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
      .notes{
        width:305px;    
      }
       
        #snapshot {
            display: none;
            max-width: 100%;
            height: auto;
          
        }

        #success_msg {
            display: none;
        }

       
        .container mx-auto {
            max-width: 100%;
            padding: 1rem;
        }
        
      
        .flex-xl-5, .flex-xl-6 {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto text-center">
        <h1 class="text-center text-red-500">Face Liveness</h1>
        <div class="flex flex-wrap -mx-2 gap-2 justify-center">
            <div class="flex-xl-6 lg:w-6/12 px-2 md:w-full px-2 p-2 rounded-5 " style="background-color:whitesmoke;">
                <div class="video-container mx-auto">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>

                <div class="w-full" style="display: flex; justify-content: center;">
                  <div class="notes" style="border: 2px solid black; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                   <div class="w-full bg-white mt-0" style="height: 50px;">
                    <p class="text-red-500" id="distance_alert_message"></p>
                   </div>
                    <p>Distance Score: <span id="distance_score"></span><br>Alignment Score: <span id="al_score"></span></p>
                    <div class="w-full" style="border: 2px solid blue;">
                      <div class="d-grid">
                        <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm bg-blue-500 hover:bg-blue-700 text-white captured-inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm" block onclick="captureImage()" id="captureButton" disabled>Capture</button>  
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            <div class="flex-xl-5 lg:w-5/12 px-2 md:w-full px-2 p-2 rounded-5 flex justify-center items-center flex-flex" style="background-color:whitesmoke;">
                <img id="snapshot" src="" class="img-thumbnail img-fluid" alt="Snapshot">
                <div id="success_msg" class="alert alert-success w-full mt-2" role="alert">
                    Successfully Took a Photo
                </div>
            </div>

            
        </div>
    </div>
    <!-- Modal dialog box -->
    <div class="modal fade" id="alertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="alertModalLabel">Notice</h5>
              <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertMessage">
              <!-- Alert message will appear here -->
            </div>
            <div class="modal-footer">
              <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm bg-gray-500 hover:bg-gray-700 text-white" data-bs-dismiss="modal">Try again</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Second Modal Dialog Box -->
<div class="modal fade" id="secondAlertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="secondAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="secondAlertModalLabel"> Notice</h5>
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              
               <p>Failed <br>Hi, Your Image Quality is <span id="orginal_score_2"></span>%</p>
               <p>Hi, We could not verify your face. <br>1. Ensure your face is facing towards light source
               <br> 2. Click 'Take Picture'
                </p>
                <p>We will verify and move you to Next Step
                </p>
                <p>Note: We need your image quality to meet minimum 85% and above for succesfull verification</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm bg-gray-500 hover:bg-gray-700 text-white" onclick="videoplay()" data-bs-dismiss="modal">Try again</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="thirdAlertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="thirdAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="thirdAlertModalLabel"> Notice</h5>
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Success <br>Face Liveness Confidence <span id="orginal_score_3"></span>%</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm bg-gray-500 hover:bg-gray-700 text-white" data-bs-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>



    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.15.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const alScoreDisplay = document.getElementById('al_score');
        const snapshot = document.getElementById('snapshot');
        const successmsg = document.getElementById('success_msg');
        const captureButton = document.getElementById("captureButton");
        const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
        const alertMessage = document.getElementById("alertMessage");
        const distancemessage=document.getElementById("distance_alert_message")
        let imageCaptured = false;
      
        const secondAlertModal = new bootstrap.Modal(document.getElementById('secondAlertModal'));
        const secondAlertMessage = document.getElementById('orginal_score_2');

        const thirdAlertModal = new bootstrap.Modal(document.getElementById('thirdAlertModal'));
        const thirdAlertMessage = document.getElementById('orginal_score_3');

        // Function to show message in modal
        function showModalMessage(message) {
            alertMessage.innerText = message;
            alertModal.show();
        }


        function showSecondModalMessage(message) {
            secondAlertMessage.innerText = message;
            secondAlertModal.show();
        }

        function showThirdModalMessage(message) {
            console.log("va:",message)
            thirdAlertMessage.innerText = message;
            thirdAlertModal.show();
        }


        function videoplay(){
            videoElement.play()
        }
        // Initialize FaceMesh and Camera
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
            maxNumFaces: 2,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => await faceMesh.send({ image: videoElement }),
            width: 300,
            height: 300
        });
        camera.start();

        canvasElement.width = 300;
        canvasElement.height = 300;

        function calculateAlignmentScore(landmarks) {
            const centerX = canvasElement.width / 2;
            const targetY = 100;
            const leftEyeCenter = landmarks[33];
            const rightEyeCenter = landmarks[263];
            const avgX = (leftEyeCenter.x + rightEyeCenter.x) / 2;
            const avgY = (leftEyeCenter.y + rightEyeCenter.y) / 2;
            const faceCenterX = avgX * canvasElement.width;
            const faceCenterY = avgY * canvasElement.height;

            const distanceX = Math.abs(centerX - faceCenterX);
            const distanceY = Math.abs(targetY - faceCenterY);

            const thresholdX = 30;
            const thresholdY = 30;

            const scoreX = distanceX < thresholdX ? 100 : Math.max(0, 100 - (distanceX / (canvasElement.width / 2)) * 100);
            const scoreY = distanceY < thresholdY ? 100 : Math.max(0, 100 - (distanceY / (canvasElement.height / 2)) * 100);

            return Math.round((scoreX + scoreY) / 2);
        }

        function calculateFaceSize(landmarks) {
        const leftEye = landmarks[33];  // Left eye landmark
        const rightEye = landmarks[263]; // Right eye landmark
        const nose = landmarks[1]; // Nose landmark

        // Calculate horizontal distance between the eyes
        const eyeDistance = Math.sqrt(
            Math.pow((rightEye.x - leftEye.x), 2) + Math.pow((rightEye.y - leftEye.y), 2)
        );

        // Calculate vertical distance from eyes to nose
        const eyeToNoseDistance = Math.sqrt(
            Math.pow((nose.x - leftEye.x), 2) + Math.pow((nose.y - leftEye.y), 2)
        );

        // Face size score can be a combination of these distances
        return {
            eyeDistance,
            eyeToNoseDistance,
            faceSize: eyeDistance * eyeToNoseDistance // A simple metric for face size
        };
    }
    function onResults(results) {
    if (imageCaptured) return;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    const numFaces = results.multiFaceLandmarks ? results.multiFaceLandmarks.length : 0;

    const dis_sc = parseInt(distance_score.innerText.match(/\d+/)?.[0] || '0');


    if (numFaces === 1) {
        const landmarks = results.multiFaceLandmarks[0];

  
        const { faceSize } = calculateFaceSize(landmarks);
        const faceSizeThreshold = 0.02; 
        const distanceScore = calculateDistanceScore(faceSize, faceSizeThreshold);
        const distanceScoreDisplay = document.getElementById('distance_score');
        distanceScoreDisplay.innerText = `${distanceScore}%`;
        
        if(distanceScore < 90){
          distancemessage.innerHTML=`Your face is too far from the camera. <br> Please move closer.`
          captureButton.disabled = true;  
          return;
        }
        
       else if (distanceScore > 90) {
            distancemessage.innerHTML=" "
            captureButton.disabled = false;  
            
        }
        
        
        const alignmentScore = calculateAlignmentScore(landmarks);
        alScoreDisplay.innerText = `${alignmentScore}%`;

 
        if (alignmentScore >=85) {
            // Check if eyes are open
            if (!checkEyesOpen(landmarks)) {
                return;
            }

            if (alignmentScore === 100) {
                captureImage();
                imageCaptured = true;
                captureButton.disabled = true;
            }

            detectPupilAndEstimateGaze(landmarks);
            drawFaceOvalLines(canvasCtx, landmarks);
        } else {
            captureButton.disabled = true; // Disable the capture button if alignment score is below 70%
        }
    }
     
  //  Then, check if there are multiple faces detected
    if (dis_sc >= 90 && numFaces > 1) {
            showModalMessage('Multiple faces detected. Please show only one face.');
            return;
        }

    canvasCtx.restore();
}


function calculateDistanceScore(faceSize, threshold) {
    let score = 100;
    if (faceSize < threshold) {
        score = Math.max(0, (faceSize / threshold) * 100); 
    }
    return Math.round(score); 
}



        function checkEyesOpen(landmarks) {
            const leftEAR = calculateEAR(landmarks[159], landmarks[145], landmarks[133], landmarks[144]);
            const rightEAR = calculateEAR(landmarks[386], landmarks[374], landmarks[362], landmarks[383]);
            const earThreshold = 0.1;
            if (leftEAR < earThreshold && rightEAR < earThreshold) {
                showModalMessage("Please open your eyes.");
                return false;
            }
            return true;
        }

        function calculateEAR(upper, lower, outer, inner) {
            const verticalDistance = (upper.y - lower.y) * canvasElement.height;
            const horizontalDistance = (outer.x - inner.x) * canvasElement.width;
            return verticalDistance / horizontalDistance;
        }

        function detectPupilAndEstimateGaze(landmarks) {
            drawPupil(canvasCtx, landmarks[468]);
            drawPupil(canvasCtx, landmarks[473]);
        }

        function drawPupil(ctx, irisCenter) {
            const pupilX = irisCenter.x * canvasElement.width;
            const pupilY = irisCenter.y * canvasElement.height;
             ctx.fillStyle = 'transparent';
            ctx.beginPath();
            ctx.arc(pupilX, pupilY, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        function drawFaceOvalLines(ctx, landmarks) {
            const ovalCenterX = canvasElement.width / 2;
            const ovalCenterY = canvasElement.height / 2;
            ctx.strokeStyle = 'green';
            ctx.beginPath();
            ctx.moveTo(0, ovalCenterY);
            ctx.lineTo(canvasElement.width, ovalCenterY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(ovalCenterX, 0);
            ctx.lineTo(ovalCenterX, canvasElement.height);
            ctx.stroke();
        }

        function captureImage() {
            const snapshotCanvas = document.createElement('canvas');
            snapshotCanvas.width = canvasElement.width;
            snapshotCanvas.height = canvasElement.height;
            const snapshotCtx = snapshotCanvas.getContext('2d');
            snapshotCtx.drawImage(videoElement, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
            const globalBase64Value = snapshotCanvas.toDataURL('image/png');
            snapshot.src = globalBase64Value;
            snapshot.style.display = 'block';
            successmsg.style.display = 'block';
            
            captureButton.disabled = true;
          // const alignmentScore = parseInt(alScoreDisplay.innerText.split(':')[1].trim().replace('%', ''));
           check_data(globalBase64Value);
            videoElement.pause();
           
        }

        async function check_data(base64) {
            const cleanedBase64 = base64.replace(/^data:image\/png;base64,/, '');
            const apiurl='https://dfa.w3webtechnologies.co.in/ar-works/api-face-liveness.php'
            const formData = new FormData();
            formData.append('img_data', cleanedBase64);

            try {
                const response = await fetch(apiurl, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error("API request failed");
                }
                const result = await response.json();
            
                const status=result.status
                if(status==='ok'){
                const success=result.livenessData.success
                const realscore=(result.livenessData.doc_json.real * 100)
                
                    if(realscore <= 85){
                      
                        showSecondModalMessage(realscore)
                    }
                    else{
        
                        showThirdModalMessage(realscore)
                    }
                }
                else{
                    alert(data.msg)
                }
            } catch (error) {
               showModalMessage("Error: " + error.message);
            }
        }
        

    </script>
</body>
</html>

